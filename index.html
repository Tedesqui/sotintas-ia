<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ğ’ğğ“ğˆğğ“ğ€ğ’ ğˆğ€ ğ‡ğğ‹ğğ†ğ‘ğ€ğŒğ€</title>

  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    /* --- Estilos Gerais --- */
    body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

    /* Mensagem Inicial */
    #initialMessage {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      padding: 20px; background-color: rgba(0, 0, 0, 0.85); color: white; border-radius: 12px;
      text-align: center; font-size: 16px; z-index: 1001; max-width: 80%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5); backdrop-filter: blur(5px);
      transition: opacity 0.5s;
    }

    /* --- BotÃ£o Play/Pause --- */
    #playPauseButton {
      position: fixed; top: 20px; left: 20px; z-index: 999;
      background-color: rgba(0, 0, 0, 0.42); border: none; border-radius: 5px; cursor: pointer;
      transition: transform 0.3s ease, background-color 0.3s ease, padding 0.3s ease;
      display: inline-flex; align-items: center; gap: 4px; color: white;
    }
    #playPauseButton.is-playing { padding: 10px 20px; }
    #playPauseButton.is-paused { padding: 2px 6px; }

    #playPauseButton .icon { color: #28a745; transition: font-size 0.3s ease; }
    #playPauseButton.is-playing .icon { font-size: 24px; margin-right: 5px; }
    #playPauseButton.is-paused .icon { font-size: 44px; position: relative; bottom: 3px; left: 2px; }
    #playPauseButton .text { font-size: 16px; color: white; }

    #playPauseButton.rotating { transform: rotate(360deg); }
    #playPauseButton:hover { background-color: rgba(0, 0, 0, 0.6); transform: scale(1.05); }

    /* --- BotÃ£o IA --- */
    #scanColorButton {
      position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%);
      z-index: 999; background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white; border: none; border-radius: 50px;
      padding: 14px 28px; font-weight: bold; font-size: 16px;
      cursor: pointer; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
      display: flex; align-items: center; gap: 10px;
      transition: transform 0.2s ease;
    }
    #scanColorButton:active { transform: translateX(-50%) scale(0.95); }

    /* --- NotificaÃ§Ã£o (Toast) --- */
    #notificationToast {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95); color: #1f2937;
      padding: 16px 24px; border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      z-index: 2000; display: flex; flex-direction: column; align-items: center;
      transition: top 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      width: 85%; max-width: 350px; text-align: center;
      border-left: 5px solid #3b82f6;
    }
    #notificationToast.show { top: 30px; }
    #notificationToast h3 { margin: 0 0 4px 0; font-size: 18px; color: #111827; }
    #notificationToast p { margin: 0; font-size: 14px; color: #4b5563; }

    /* --- Loading Overlay --- */
    #loadingOverlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(3px);
      z-index: 2000; flex-direction: column; align-items: center; justify-content: center;
      color: white;
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #3b82f6; border-radius: 50%;
      animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- Footer Social --- */
    #footerSocial {
      position: fixed; bottom: 0; left: 0; right: 0; padding: 25px 0;
      display: flex; justify-content: center; gap: 40px; z-index: 999;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    }
    #footerSocial a { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; transition: transform 0.2s; }
    #footerSocial a:hover { transform: scale(1.1); }
    #footerSocial svg { width: 100%; height: 100%; drop-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    #footerSocial .facebook svg { fill: #00008B; }
    #footerSocial .instagram svg { fill: #833AB4; }
    #footerSocial .whatsapp svg { fill: #25D366; }
  </style>
</head>

<body>
  
  <div id="notificationToast">
    <h3 id="toastTitle">Sucesso!</h3>
    <p id="toastMessage">Cor identificada.</p>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-weight: 500;">Analisando ambiente...</div>
  </div>

  <div id="initialMessage">
    Aponte para a parede e clique em <b>"Identificar Cor"</b>
  </div>

  <button id="playPauseButton" class="is-paused">
    <span class="icon">â–¶ï¸</span> <span class="text">Play</span>
  </button>

  <button id="scanColorButton">
    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
    </svg>
    Identificar Cor
  </button>

  <canvas id="snapshotCanvas" style="display:none;"></canvas>

  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
    <a-assets>
      <video id="Video_Asset_0" src="videos/celia.mp4" playsinline webkit-playsinline loop crossorigin="anonymous"></video>
    </a-assets>

    <a-entity id="video-holder" position="0 0 -100" scale="0 0 0">
       <a-video width="2.53" height="4.5" src="#Video_Asset_0" look-at="[camera]" color="#FFFFFF" loop></a-video>
    </a-entity>

    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <div id="footerSocial">
    <a href="https://www.facebook.com/gruposotintas/" target="_blank" class="facebook"><svg viewBox="0 0 24 24"><path d="M22 12a10 10 0 1 0-11.5 9.87v-6.98h-3v-2.89h3v-2.2c0-3 1.79-4.66 4.53-4.66 1.31 0 2.68.24 2.68.24v3h-1.54c-1.52 0-1.99.95-1.99 1.92v2.7h3.4l-.54 2.89h-2.86v6.98A10 10 0 0 0 22 12"/></svg></a>
    <a href="https://www.instagram.com/sotintasnet/" target="_blank" class="instagram"><svg viewBox="0 0 24 24"><path d="M7 2C4.243 2 2 4.243 2 7v10c0 2.757 2.243 5 5 5h10c2.757 0 5-2.243 5-5V7c0-2.757-2.243-5-5-5H7zm0 2h10c1.654 0 3 1.346 3 3v10c0 1.654-1.346 3-3 3H7c-1.654 0-3-1.346-3-3V7c0-1.654 1.346-3 3-3zm5 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm4.5-.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></a>
    <a href="https://wa.me/5524999818680" target="_blank" class="whatsapp"><svg viewBox="0 0 24 24"><path d="M20.52 3.48A11.955 11.955 0 0 0 12 0a12 12 0 0 0-11.99 11.89c0 2.12.56 4.09 1.52 5.82L0 24l6.6-2.43A11.95 11.95 0 0 0 12 24c6.63 0 12-5.37 12-12a11.89 11.89 0 0 0-3.48-8.52zm-8.52 15.2c-1.95 0-3.77-.62-5.23-1.68l-.37-.23-3.1 1.14 1.15-3.03-.24-.38a8.39 8.39 0 0 1-1.31-4.88c0-4.65 3.78-8.42 8.42-8.42 2.24 0 4.35.88 5.92 2.48a8.288 8.288 0 0 1 2.5 6c0 4.65-3.78 8.43-8.43 8.43zm4.52-6.28c-.25-.12-1.47-.72-1.7-.8-.23-.08-.4-.12-.57.12-.16.25-.62.8-.76.97-.14.16-.28.18-.53.06-.25-.13-1.05-.39-2-1.24-.74-.66-1.24-1.47-1.38-1.72-.14-.25-.02-.38.11-.5.11-.11.25-.29.37-.44.12-.15.16-.25.25-.42.08-.16.04-.31-.02-.44-.06-.13-.57-1.37-.78-1.87-.2-.49-.41-.42-.57-.43-.15-.01-.32-.01-.49-.01-.16 0-.42.06-.64.31-.22.25-.84.82-.84 2 .01 1.18.86 2.32.98 2.49.12.17 1.7 2.6 4.12 3.64.58.25 1.03.4 1.38.51.58.18 1.11.15 1.53.09.47-.07 1.47-.6 1.68-1.18.21-.58.21-1.07.15-1.18-.06-.11-.22-.18-.47-.3z"/></svg></a>
  </div>

  <script>
    const colorVideoMap = {
      "branco": "videos/video_branco.mp4",
      "azul": "videos/video_azul.mp4",
      "verde": "videos/video_verde.mp4",
      "amarelo": "videos/video_amarelo.mp4",
      "vermelho": "videos/video_vermelho.mp4",
      "cinza": "videos/video_cinza.mp4",
      "padrao": "videos/celia.mp4"
    };

    const video = document.querySelector('#Video_Asset_0');
    const playPauseButton = document.getElementById('playPauseButton');
    const scanButton = document.getElementById('scanColorButton');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');

    function showNotification(title, message) {
      const toast = document.getElementById('notificationToast');
      document.getElementById('toastTitle').innerText = title;
      document.getElementById('toastMessage').innerText = message;
      toast.classList.add('show');
      setTimeout(() => { toast.classList.remove('show'); }, 4000);
    }

    // --- POSICIONAMENTO CORRIGIDO (USANDO VETOR LOCAL) ---
    function placeVideoInFront() {
      const videoEl = document.querySelector('#video-holder');
      const cameraEl = document.querySelector('a-camera');

      if (!videoEl || !cameraEl) return;

      const cameraObj = cameraEl.object3D;
      
      // Define uma distÃ¢ncia maior: 6 metros
      const distance = 6; 
      
      // Cria um vetor apontando para a "frente" no espaÃ§o local da cÃ¢mera (eixo Z negativo)
      const localForward = new THREE.Vector3(0, 0, -distance);
      
      // Aplica a rotaÃ§Ã£o da cÃ¢mera a esse vetor
      localForward.applyQuaternion(cameraObj.quaternion);
      
      // Soma com a posiÃ§Ã£o atual da cÃ¢mera para obter a posiÃ§Ã£o final no mundo
      const finalPosition = new THREE.Vector3().copy(cameraObj.position).add(localForward);
      
      // Aplica ao objeto do vÃ­deo
      videoEl.object3D.position.copy(finalPosition);

      // AnimaÃ§Ã£o de entrada (Crescer)
      videoEl.setAttribute('animation', {
        property: 'scale',
        to: '1 1 1',
        dur: 1500,
        easing: 'easeOutElastic'
      });
    }

    // --- LÃ“GICA PRINCIPAL ---
    scanButton.addEventListener('click', async () => {
      if (!video.paused) {
        video.pause();
        updatePlayButtonState(false);
      }

      loadingOverlay.style.display = 'flex';
      loadingText.innerText = "Analisando cores e ambiente...";

      try {
        const webcamVideo = document.querySelector('video:not(#Video_Asset_0)'); 
        if (!webcamVideo) throw new Error("CÃ¢mera nÃ£o iniciada.");

        const canvas = document.getElementById('snapshotCanvas');
        const scale = 512 / webcamVideo.videoWidth;
        canvas.width = 512;
        canvas.height = webcamVideo.videoHeight * scale;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(webcamVideo, 0, 0, canvas.width, canvas.height);
        const base64Image = canvas.toDataURL('image/jpeg', 0.6); 

        const response = await fetch('/api/identify-color', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: base64Image })
        });

        if (!response.ok) throw new Error("Erro de conexÃ£o com servidor.");

        const data = await response.json();
        
        showNotification(
          data.tonalidade.toUpperCase(), 
          `Base: ${data.categoria.toUpperCase()}.`
        );

        const cleanCategory = data.categoria.toLowerCase().trim();
        const newSrc = colorVideoMap[cleanCategory] || colorVideoMap['padrao'];
        video.src = newSrc;
        video.load(); 

        // Reposiciona o vÃ­deo corretamente na frente
        placeVideoInFront();

        setTimeout(() => {
          video.play().then(() => {
            updatePlayButtonState(true);
          }).catch(e => {
            updatePlayButtonState(false);
          });
        }, 500);

      } catch (error) {
        console.error(error);
        showNotification("Erro", "NÃ£o foi possÃ­vel identificar.");
      } finally {
        loadingOverlay.style.display = 'none';
      }
    });

    function updatePlayButtonState(isPlaying) {
      if (isPlaying) {
        playPauseButton.innerHTML = '<span class="icon">â¸ï¸</span> <span class="text">Pause</span>';
        playPauseButton.classList.remove('is-paused');
        playPauseButton.classList.add('is-playing');
      } else {
        playPauseButton.innerHTML = '<span class="icon">â–¶ï¸</span> <span class="text">Play</span>';
        playPauseButton.classList.remove('is-playing');
        playPauseButton.classList.add('is-paused');
      }
    }

    window.addEventListener('load', () => {
      const message = document.getElementById('initialMessage');
      if (message) {
        setTimeout(() => {
          message.style.opacity = '0';
          setTimeout(() => message.style.display = 'none', 500);
        }, 5000); 
      }
    });

    playPauseButton.addEventListener('click', () => {
      if (video.paused) {
        video.muted = false; 
        video.play();
        updatePlayButtonState(true);
      } else {
        video.pause();
        updatePlayButtonState(false);
      }
      playPauseButton.classList.add('rotating');
      setTimeout(() => playPauseButton.classList.remove('rotating'), 300);
    });
  </script>
</body>
</html>
